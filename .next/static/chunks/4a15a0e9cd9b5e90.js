(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,70756,e=>{"use strict";let t=(0,e.i(75254).default)("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);e.s(["Lock",()=>t],70756)},78583,e=>{"use strict";let t=(0,e.i(75254).default)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]);e.s(["FileText",()=>t],78583)},20313,e=>{"use strict";var t=e.i(20755),r=e.i(44328);let s=[{id:"mat-001",title:"2024美本申请趋势解读",type:"article",source:"公众号",date:"2024-10-20",summary:"今年美本申请有这些新变化..."},{id:"mat-002",title:"文书写作避坑指南",type:"video",source:"视频号",date:"2024-10-18",summary:"分享这个视频给正在准备文书的学生"}];async function i(e){let s=(0,t.createClient)(),{page:i=1,pageSize:a=50,type:n}=e||{};try{var o,d,l;let e,{data:t,error:m}=await s.from("wechat_messages").select("room_id, from_user_id, to_user_id, content, send_time, msg_type").order("send_time",{ascending:!1}).limit(500);if(m){if(console.error("Supabase wechat_messages query failed:",m.message),"42P01"===m.code||m.message.includes("does not exist"))return(0,r.failure)({code:"TABLE_NOT_EXISTS",message:"企业微信消息表不存在，请联系管理员创建 wechat_messages 表"});if("42501"===m.code||m.message.includes("permission denied"))return(0,r.failure)({code:"PERMISSION_DENIED",message:"没有访问企业微信消息的权限"});return(0,r.failure)((0,r.createServiceError)(m,"获取会话列表失败"))}let f=(d=(o=t||[],e=new Map,o.forEach(t=>{let r;if(t.room_id)r=`room_${t.room_id}`;else if(t.from_user_id&&t.to_user_id){let e=[t.from_user_id,t.to_user_id].sort();r=`dm_${e[0]}_${e[1]}`}else r=`msg_${t.from_user_id||"unknown"}`;let s=e.get(r);!s||new Date(t.send_time||"")>new Date(s.lastMessage.send_time||"")?e.set(r,{id:r,lastMessage:t,messageCount:(s?.messageCount||0)+1}):s&&s.messageCount++}),Array.from(e.values()).map(e=>{let t=e.lastMessage,r=u(t.content);return{id:e.id,name:t.room_id?`群聊 ${t.room_id.slice(0,8)}`:`用户 ${t.from_user_id?.slice(0,8)||"Unknown"}`,type:t.room_id?"group":"student",lastMessage:r.slice(0,50)+(r.length>50?"...":""),lastMessageTime:c(t.send_time||""),unreadCount:0,isOverdue:!1}})),(l=n)&&"all"!==l?"internal"===l?d.filter(e=>"internal"===e.type||"group"===e.type):d.filter(e=>e.type===l):d),_=(i-1)*a,g=f.slice(_,_+a);return(0,r.success)({data:g,total:f.length})}catch(e){return console.error("getConversationList error:",e),(0,r.failure)((0,r.createServiceError)(e,"获取会话列表失败"))}}async function a(e,s){let i=(0,t.createClient)(),{limit:a=50,before:n}=s||{};try{let t=i.from("wechat_messages").select("*").order("send_time",{ascending:!1}).limit(a+1);if(e.startsWith("room_")){let r=e.replace("room_","");t=t.eq("room_id",r)}else if(e.startsWith("dm_")){let r=e.replace("dm_","").split("_");r.length>=2&&(t=t.or(`and(from_user_id.eq.${r[0]},to_user_id.eq.${r[1]}),and(from_user_id.eq.${r[1]},to_user_id.eq.${r[0]})`))}n&&(t=t.lt("send_time",n));let{data:s,error:u}=await t;if(u)return console.error("Supabase messages query failed:",u.message),(0,r.failure)((0,r.createServiceError)(u,"获取消息列表失败"));let c=(s?.length||0)>a,d=(s||[]).slice(0,a).map(o);return(0,r.success)({data:d.reverse(),hasMore:c})}catch(e){return console.error("getConversationMessages error:",e),(0,r.failure)((0,r.createServiceError)(e,"获取消息列表失败"))}}async function n(){return(0,r.success)(s)}function o(e){return{id:e.id,conversationId:e.room_id?`room_${e.room_id}`:`dm_${e.from_user_id}_${e.to_user_id}`,senderName:e.from_user_id?.slice(0,8)||"Unknown",senderId:e.from_user_id,content:u(e.content),timestamp:c(e.send_time),isMe:!1,type:function(e){switch(e?.toLowerCase()){case"text":default:return"text";case"image":return"image";case"voice":return"voice";case"video":return"video";case"file":return"file";case"link":return"link"}}(e.msg_type)}}function u(e){if(!e)return"[空消息]";if("string"==typeof e)return e;if(e.text)return String(e.text);if(e.content)return String(e.content);if(e.message)return String(e.message);switch(e.msgtype||e.type){case"image":return"[图片]";case"voice":return"[语音]";case"video":return"[视频]";case"file":return"[文件]";case"link":return"[链接]";case"miniprogram":return"[小程序]";case"location":return"[位置]";default:return"[消息]"}}function c(e){if(!e)return"";try{let t=new Date(e),r=new Date().getTime()-t.getTime(),s=Math.floor(r/6e4),i=Math.floor(r/36e5),a=Math.floor(r/864e5);if(s<1)return"刚刚";if(s<60)return`${s}分钟前`;if(i<24)return t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});if(1===a)return"昨天";if(a<7)return`${a}天前`;return t.toLocaleDateString("zh-CN",{month:"numeric",day:"numeric"})}catch{return e}}e.s(["getConversationList",()=>i,"getConversationMessages",()=>a,"getMarketingMaterials",()=>n])},16715,78917,e=>{"use strict";var t=e.i(75254);let r=(0,t.default)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);e.s(["RefreshCw",()=>r],16715);let s=(0,t.default)("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);e.s(["ExternalLink",()=>s],78917)}]);