module.exports=[43108,a=>{"use strict";let b=(0,a.i(70106).default)("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);a.s(["Lock",()=>b],43108)},4720,a=>{"use strict";let b=(0,a.i(70106).default)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]);a.s(["FileText",()=>b],4720)},99278,a=>{"use strict";var b=a.i(69240),c=a.i(9444);let d=[{id:"mat-001",title:"2024美本申请趋势解读",type:"article",source:"公众号",date:"2024-10-20",summary:"今年美本申请有这些新变化..."},{id:"mat-002",title:"文书写作避坑指南",type:"video",source:"视频号",date:"2024-10-18",summary:"分享这个视频给正在准备文书的学生"}];async function e(a){let d=(0,b.createClient)(),{page:e=1,pageSize:f=50,type:g}=a||{};try{var h,k,l;let a,{data:b,error:m}=await d.from("wechat_messages").select("room_id, from_user_id, to_user_id, content, send_time, msg_type").order("send_time",{ascending:!1}).limit(500);if(m){if(console.error("Supabase wechat_messages query failed:",m.message),"42P01"===m.code||m.message.includes("does not exist"))return(0,c.failure)({code:"TABLE_NOT_EXISTS",message:"企业微信消息表不存在，请联系管理员创建 wechat_messages 表"});if("42501"===m.code||m.message.includes("permission denied"))return(0,c.failure)({code:"PERMISSION_DENIED",message:"没有访问企业微信消息的权限"});return(0,c.failure)((0,c.createServiceError)(m,"获取会话列表失败"))}let n=(k=(h=b||[],a=new Map,h.forEach(b=>{let c;if(b.room_id)c=`room_${b.room_id}`;else if(b.from_user_id&&b.to_user_id){let a=[b.from_user_id,b.to_user_id].sort();c=`dm_${a[0]}_${a[1]}`}else c=`msg_${b.from_user_id||"unknown"}`;let d=a.get(c);!d||new Date(b.send_time||"")>new Date(d.lastMessage.send_time||"")?a.set(c,{id:c,lastMessage:b,messageCount:(d?.messageCount||0)+1}):d&&d.messageCount++}),Array.from(a.values()).map(a=>{let b=a.lastMessage,c=i(b.content);return{id:a.id,name:b.room_id?`群聊 ${b.room_id.slice(0,8)}`:`用户 ${b.from_user_id?.slice(0,8)||"Unknown"}`,type:b.room_id?"group":"student",lastMessage:c.slice(0,50)+(c.length>50?"...":""),lastMessageTime:j(b.send_time||""),unreadCount:0,isOverdue:!1}})),(l=g)&&"all"!==l?"internal"===l?k.filter(a=>"internal"===a.type||"group"===a.type):k.filter(a=>a.type===l):k),o=(e-1)*f,p=n.slice(o,o+f);return(0,c.success)({data:p,total:n.length})}catch(a){return console.error("getConversationList error:",a),(0,c.failure)((0,c.createServiceError)(a,"获取会话列表失败"))}}async function f(a,d){let e=(0,b.createClient)(),{limit:f=50,before:g}=d||{};try{let b=e.from("wechat_messages").select("*").order("send_time",{ascending:!1}).limit(f+1);if(a.startsWith("room_")){let c=a.replace("room_","");b=b.eq("room_id",c)}else if(a.startsWith("dm_")){let c=a.replace("dm_","").split("_");c.length>=2&&(b=b.or(`and(from_user_id.eq.${c[0]},to_user_id.eq.${c[1]}),and(from_user_id.eq.${c[1]},to_user_id.eq.${c[0]})`))}g&&(b=b.lt("send_time",g));let{data:d,error:i}=await b;if(i)return console.error("Supabase messages query failed:",i.message),(0,c.failure)((0,c.createServiceError)(i,"获取消息列表失败"));let j=(d?.length||0)>f,k=(d||[]).slice(0,f).map(h);return(0,c.success)({data:k.reverse(),hasMore:j})}catch(a){return console.error("getConversationMessages error:",a),(0,c.failure)((0,c.createServiceError)(a,"获取消息列表失败"))}}async function g(){return(0,c.success)(d)}function h(a){return{id:a.id,conversationId:a.room_id?`room_${a.room_id}`:`dm_${a.from_user_id}_${a.to_user_id}`,senderName:a.from_user_id?.slice(0,8)||"Unknown",senderId:a.from_user_id,content:i(a.content),timestamp:j(a.send_time),isMe:!1,type:function(a){switch(a?.toLowerCase()){case"text":default:return"text";case"image":return"image";case"voice":return"voice";case"video":return"video";case"file":return"file";case"link":return"link"}}(a.msg_type)}}function i(a){if(!a)return"[空消息]";if("string"==typeof a)return a;if(a.text)return String(a.text);if(a.content)return String(a.content);if(a.message)return String(a.message);switch(a.msgtype||a.type){case"image":return"[图片]";case"voice":return"[语音]";case"video":return"[视频]";case"file":return"[文件]";case"link":return"[链接]";case"miniprogram":return"[小程序]";case"location":return"[位置]";default:return"[消息]"}}function j(a){if(!a)return"";try{let b=new Date(a),c=new Date().getTime()-b.getTime(),d=Math.floor(c/6e4),e=Math.floor(c/36e5),f=Math.floor(c/864e5);if(d<1)return"刚刚";if(d<60)return`${d}分钟前`;if(e<24)return b.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});if(1===f)return"昨天";if(f<7)return`${f}天前`;return b.toLocaleDateString("zh-CN",{month:"numeric",day:"numeric"})}catch{return a}}a.s(["getConversationList",()=>e,"getConversationMessages",()=>f,"getMarketingMaterials",()=>g])},69520,52495,a=>{"use strict";var b=a.i(70106);let c=(0,b.default)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);a.s(["RefreshCw",()=>c],69520);let d=(0,b.default)("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);a.s(["ExternalLink",()=>d],52495)}];

//# sourceMappingURL=_9a64c0e1._.js.map